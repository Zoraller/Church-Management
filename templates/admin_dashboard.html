<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ---------- General ---------- */
body { background: #f8f9fa; font-family: Arial, sans-serif; }
.card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: 0.2s; }

/* ---------- Sidebar ---------- */
.sidebar {
  position: fixed; top:0; left: -220px; width: 220px; height: 100vh;
  background: #4b4f53; color:white; padding-top:20px; transition:left 0.3s; z-index:1001;
}
.sidebar.show { left:0; }
.sidebar a { color:white; display:block; padding:10px 20px; text-decoration:none; }
.sidebar a:hover { background:#495057; }
.sidebar .sidebar-logo { max-width:120px; border-radius:50%; padding:5px; background:#343a40; display:block; margin:auto; }

/* ---------- Main Content ---------- */
.main-content { margin-left:0; margin-right:0; padding:20px; padding-bottom:80px; }
.time-card { display:inline-block; padding:6px 12px; font-size:0.7rem; font-weight:bold; color:#fff; background:#616d79; border-radius:8px; }

/* ---------- Right Panel (Events) ---------- */
.right-panel {
  position: fixed; top:0; right:0; width:300px; height:100vh; background:#f8f9fa; z-index:1000;
  overflow-y:auto; box-shadow:-2px 0 5px rgba(0,0,0,0.1); padding-top:60px;
}
.event-card { padding:10px; border-bottom:1px solid #ddd; transition:0.2s; }
.event-card:hover { transform:translateY(-2px); box-shadow:0 2px 8px rgba(0,0,0,0.1); text-decoration:none; color:inherit; }
.card-body::-webkit-scrollbar { width:6px; }
.card-body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius:10px; }

/* ---------- Bottom Navigation ---------- */
.bottom-nav {
  position: fixed; bottom:0; left:0; right:0; background:#4b4f53; color:white; display:flex; justify-content:space-around; padding:10px 0; z-index:1000;
}
.bottom-nav a { color:white; text-decoration:none; text-align:center; flex:1; }
.bottom-nav i { font-size:1.2rem; } .bottom-nav span { display:block; font-size:0.8rem; }

/* ---------- Hamburger ---------- */
.hamburger { position:fixed; top:10px; left:10px; z-index:1002; background:#4b4f53; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; }

/* ---------- Overlay ---------- */
.overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; }
.overlay.show { display:block; }

/* ---------- Responsive ---------- */
@media (min-width:769px) {
  .sidebar { left:0; } 
  .main-content { margin-left:220px; margin-right:300px; }
  .right-panel { display:block; }
  .bottom-nav, .hamburger { display:none; }
}
@media (max-width:768px) {
  .right-panel { display:none; }
}
</style>
</head>
<body>

<!-- Hamburger & Overlay -->
<button class="hamburger" id="hamburgerBtn"><i class="fa-solid fa-bars"></i></button>
<div class="overlay" id="overlay"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <img src="{{ url_for('static', filename='images/cross-background.jpg') }}" class="sidebar-logo mb-2" alt="logo">
  <hr>
  <a href="{{ url_for('admin_dashboard') }}"><i class="fa-solid fa-house me-2"></i>Dashboard</a>

  <!-- Sidebar Dropdown Example -->
  {% macro sidebar_dropdown(icon, label, links, collapse_id) %}
    <a class="collapsed" data-bs-toggle="collapse" href="#{{ collapse_id }}" role="button" aria-expanded="false">
      <i class="fa-solid {{ icon }}"></i> {{ label }}
      <i class="fa-solid fa-chevron-down float-end"></i>
    </a>
    <div class="collapse" id="{{ collapse_id }}">
      {% for link in links %}
        <a href="{{ url_for(link.endpoint) }}" class="ps-4 d-block">
          <i class="fa-solid {{ link.icon }} me-2"></i> {{ link.label }}
        </a>
      {% endfor %}
    </div>
  {% endmacro %}

  {{ sidebar_dropdown('fa-users', 'Members', [{'endpoint':'add_members','icon':'fa-user-plus','label':'Add Member'}, {'endpoint':'view_members','icon':'fa-table','label':'View Members'}], 'membersDropdown') }}
  {{ sidebar_dropdown('fa-church', 'Ministries', [{'endpoint':'add_ministry','icon':'fa-plus','label':'Add Ministry'}, {'endpoint':'admin_ministries','icon':'fa-list','label':'View Ministries'}], 'ministriesDropdown') }}
  {{ sidebar_dropdown('fa-people-group', 'Life Groups', [{'endpoint':'add_lifegroup','icon':'fa-plus','label':'Add LifeGroup'}, {'endpoint':'admin_lifegroups','icon':'fa-list','label':'View Life Groups'}], 'lifegroupsDropdown') }}
  {{ sidebar_dropdown('fa-hand-holding-dollar', 'Tithes & Expenses', [
      {'endpoint':'add_tithe','icon':'fa-plus','label':'Add Tithe'},
      {'endpoint':'view_tithes','icon':'fa-table','label':'View Tithes'},
      {'endpoint':'add_expense','icon':'fa-circle-plus','label':'Add Expense'},
      {'endpoint':'view_expenses','icon':'fa-list','label':'View Expenses'}
  ], 'tithesDropdown') }}
  {{ sidebar_dropdown('fa-calendar-days', 'Events', [{'endpoint':'add_event','icon':'fa-plus','label':'Add Event'}, {'endpoint':'view_events','icon':'fa-list','label':'View Events'}], 'eventsDropdown') }}
  {{ sidebar_dropdown('fa-user', 'Users', [{'endpoint':'add_user','icon':'fa-user-plus','label':'Add User'}, {'endpoint':'view_users','icon':'fa-table','label':'All Users'}], 'usersDropdown') }}
</div>

<!-- Right Panel -->
<div class="right-panel">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-bold">
      <i class="fa-solid fa-calendar-days me-2"></i>Events
    </div>
    <div class="p-1">
      <input type="text" id="eventSearch" class="form-control form-control-sm" placeholder="Search events...">
    </div>
    <ul class="nav nav-tabs nav-fill small" id="eventTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button">Upcoming</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button">Past</button>
      </li>
    </ul>
    <div class="card-body p-1" style="max-height:250px; overflow-y:auto;">
      <div class="tab-content" id="eventTabsContent">
        <!-- Upcoming -->
        <div class="tab-pane fade show active" id="upcoming">
          {% if upcoming_events %}
            {% for event in upcoming_events %}
              <a href="{{ url_for('event_detail', event_id=event.event_id) }}" class="text-decoration-none">
                <div class="card event-card mb-1 border-0 border-top border-primary border-1 shadow-sm small">
                  <div class="card-body p-1">
                    <h6 class="fw-bold text-primary mb-1 small">{{ event.event_name }}</h6>
                    <p class="text-muted mb-1 small"><i class="fa-solid fa-calendar"></i> {{ event.event_date }}</p>
                    <p class="text-muted mb-1 small"><i class="fa-solid fa-clock"></i> {{ event.event_time_formatted }}</p>
                    <p class="small text-muted mb-1">{{ event.description }}</p>
                    <p class="mb-0 small"><i class="fa-solid fa-location-dot text-danger"></i> {{ event.location }}</p>
                  </div>
                </div>
              </a>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center mb-0 small">No upcoming events.</p>
          {% endif %}
        </div>
        <!-- Past -->
        <div class="tab-pane fade" id="past">
          {% if past_events %}
            {% for event in past_events %}
              <a href="{{ url_for('event_detail', event_id=event.event_id) }}" class="text-decoration-none">
                <div class="card event-card mb-1 border-0 border-top border-secondary border-1 shadow-sm small">
                  <div class="card-body p-1">
                    <h6 class="fw-bold text-secondary mb-1 small">{{ event.event_name }}</h6>
                    <p class="text-muted mb-1 small"><i class="fa-solid fa-calendar"></i> {{ event.event_date }}</p>
                    <p class="text-muted mb-1 small"><i class="fa-solid fa-clock"></i> {{ event.event_time_formatted }}</p>
                    <p class="small text-muted mb-1">{{ event.description }}</p>
                    <p class="mb-0 small"><i class="fa-solid fa-location-dot text-danger"></i> {{ event.location }}</p>
                  </div>
                </div>
              </a>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center mb-0 small">No past events.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <div id="datetime" class="time-card mb-2"></div>

  <div class="row text-center mb-4">
    {% macro dashboard_card(title, icon, total, url) %}
      <div class="col-md-4 mb-3">
        <a href="{{ url_for(url) }}" class="text-decoration-none">
          <div class="card p-3 shadow-sm">
            <h5 class="fw-bold text-primary"><i class="fa-solid {{ icon }} me-2"></i>{{ title }}</h5>
            <p class="mb-0">Total: {{ total }}</p>
          </div>
        </a>
      </div>
    {% endmacro %}

    {{ dashboard_card('Members','fa-users', total_members,'view_members') }}
    {{ dashboard_card('Ministries','fa-church', total_ministries,'admin_ministries') }}
    {{ dashboard_card('Life Groups','fa-people-group', total_lifegroups,'admin_lifegroups') }}
  </div>

  <div id="calendar" class="mb-4"></div>

  <!-- Tithes & Expenses Cards -->
  <div class="row mb-4 justify-content-center">
    {% macro finance_card(title, icon, total, type) %}
      <div class="col-md-5 mb-3">
        <div class="card p-3 text-center shadow-sm">
          <h5 class="fw-bold text-{{ 'success' if type=='tithes' else 'danger' }}"><i class="fa-solid {{ icon }} me-2"></i>{{ title }}</h5>
          <form method="get" action="{{ url_for('view_'+type) }}">
            <div class="mb-2">
              <select id="filterType{{ type|capitalize }}" name="filter_type" class="form-select form-select-sm w-auto mx-auto" onchange="toggleInput('{{ type }}')">
                <option value="day_month" selected>By Day / Month</option>
                <option value="year">By Year</option>
              </select>
            </div>
            <input type="date" id="dateInput{{ type|capitalize }}" name="date" class="form-control form-control-sm w-auto mx-auto">
            <input type="month" id="monthInput{{ type|capitalize }}" name="month" class="form-control form-control-sm w-auto mx-auto d-none">
            <input type="number" id="yearInput{{ type|capitalize }}" name="year" min="2000" max="2100" placeholder="Enter year" class="form-control form-control-sm w-auto mx-auto d-none">
            <button class="btn btn-primary btn-sm mt-2">View</button>
          </form>
          <p class="mt-3 mb-0">Total: â‚±{{ total }}</p>
        </div>
      </div>
    {% endmacro %}

    {{ finance_card('Tithes','fa-hand-holding-dollar', total_tithes,'tithes') }}
    {{ finance_card('Expenses','fa-money-bill-wave', total_expenses,'expenses') }}
  </div>
</div>

<!-- Profile Dropdown -->
<div class="dropdown position-fixed top-0 end-0 p-2" style="z-index:1050;">
  <img src="{{ url_for('static', filename='images/iu.jpg') }}" class="profile-icon dropdown-toggle" data-bs-toggle="dropdown" alt="User">
  <ul class="dropdown-menu dropdown-menu-end">
    <li><a class="dropdown-item" href="/logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
  </ul>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <a href="{{ url_for('admin_dashboard') }}"><i class="fa-solid fa-house"></i><span>Dashboard</span></a>
  <a href="{{ url_for('view_members') }}"><i class="fa-solid fa-users"></i><span>Members</span></a>
  <a href="{{ url_for('view_events') }}"><i class="fa-solid fa-calendar-days"></i><span>Events</span></a>
  <a href="#profile" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fa-solid fa-user"></i><span>Profile</span></a>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img src="{{ url_for('static', filename='images/iu.jpg') }}" class="profile-icon mb-3" alt="User">
        <a href="/logout" class="btn btn-danger"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script>
// ---------- Sidebar Toggle ----------
const hamburgerBtn = document.getElementById('hamburgerBtn');
const overlay = document.getElementById('overlay');
const sidebar = document.getElementById('sidebar');
hamburgerBtn?.addEventListener('click', ()=>{sidebar.classList.toggle('show'); overlay.classList.toggle('show');});
overlay?.addEventListener('click', ()=>{sidebar.classList.remove('show'); overlay.classList.remove('show');});

// ---------- FullCalendar ----------
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  let eventsData = {{ events|tojson|safe }} || [];
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
    events: eventsData,
    eventClick: info => { if(info.event.url && info.event.url!=='#'){window.open(info.event.url,'_blank'); info.jsEvent.preventDefault();} },
    eventDidMount: info => { if(info.event.extendedProps?.description){info.el.setAttribute('title', info.event.extendedProps.description);} }
  });
  calendar.render();

  // Event Search
  const searchInput = document.getElementById('eventSearch');
  searchInput?.addEventListener('input', function(){
    const filter = this.value.toLowerCase();
    document.querySelectorAll('.event-card').forEach(e=>{
      const text = e.textContent.toLowerCase();
      e.style.display = text.includes(filter)?'':'none';
    });
  });
});

// ---------- Filter Toggle ----------
function toggleInput(type){
  const filterEl = document.getElementById(`filterType${type.charAt(0).toUpperCase()+type.slice(1)}`);
  if(!filterEl) return;
  const filter = filterEl.value;
  const dateInput = document.getElementById(`dateInput${type.charAt(0).toUpperCase()+type.slice(1)}`);
  const monthInput = document.getElementById(`monthInput${type.charAt(0).toUpperCase()+type.slice(1)}`);
  const yearInput = document.getElementById(`yearInput${type.charAt(0).toUpperCase()+type.slice(1)}`);
  if(filter==='day_month'){ dateInput.classList.remove('d-none'); monthInput.classList.remove('d-none'); yearInput.classList.add('d-none'); }
  else{ dateInput.classList.add('d-none'); monthInput.classList.add('d-none'); yearInput.classList.remove('d-none'); }
}

// ---------- Live DateTime ----------
function updateDateTime(){
  const now = new Date();
  document.getElementById('datetime').innerText = now.toLocaleString();
}
setInterval(updateDateTime,1000);
updateDateTime();
</script>
</body>
</html>
