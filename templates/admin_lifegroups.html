<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Life Groups</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { 
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
  font-family: 'Arial', sans-serif; 
}

/* Sidebar */
.sidebar { 
  height: 100vh; 
  background: linear-gradient(180deg, #4b4f53ff 0%, #343a40 100%); 
  color: white; 
  position: fixed; 
  width: 220px; 
  padding-top: 20px; 
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: 1050;
}
.sidebar.show { transform: translateX(0); }
.sidebar a { 
  color: white; 
  display: block; 
  padding: 10px 20px; 
  text-decoration: none; 
  transition: all 0.3s ease;
}
.sidebar a:hover { 
  background: #495057; 
  transform: translateX(5px); 
}
.sidebar a.active { 
  background: #6c757d; 
  font-weight: bold; 
  border-left: 4px solid #ffc107; 
}
.sidebar-logo { 
  max-width: 120px; 
  border-radius: 50%; 
  padding: 5px; 
  background: #343a40; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
}

/* Main Content */
.main-content { 
  margin-left: 0; 
  padding: 20px; 
  transition: margin-left 0.3s ease;
}

/* Table Container */
.table-container {
  background: linear-gradient(135deg, #ffffff, #f9f9f9);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border: 1px solid #e9ecef;
}
.table th { 
  background: linear-gradient(45deg, #4b4f53ff, #343a40); 
  color: white; 
  text-align: center; 
  border-radius: 8px 8px 0 0;
}
.table td { 
  vertical-align: middle; 
  padding: 15px;
}
.table tbody tr { 
  transition: all 0.3s ease; 
}
.table tbody tr:hover { 
  background: linear-gradient(45deg, #f1f3f6, #e3f2fd); 
  transform: translateY(-2px); 
  box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
}

/* Buttons */
.btn-add { 
  background: linear-gradient(45deg, #28a745, #20c997); 
  border: none; 
  border-radius: 25px; 
  padding: 10px 20px; 
  font-weight: bold; 
  color: white; 
  transition: all 0.3s ease; 
}
.btn-add:hover { 
  background: linear-gradient(45deg, #218838, #17a2b8); 
  transform: translateY(-2px); 
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
}
.btn-warning:hover, .btn-danger:hover, .btn-info:hover { 
  transform: translateY(-2px); 
  transition: all 0.2s ease; 
}

/* Time Card */
.time-card {
  display: inline-block;
  padding: 6px 12px;
  font-size: 0.7rem;    
  font-weight: bold;
  color: #ffffff;          
  background: #616d79ff;    
  border-radius: 8px;      
  box-shadow: 0 2px 6px rgba(202, 190, 190, 0.2);
  font-family: 'Arial', sans-serif;
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1060;
}

/* Profile Icon */
.profile-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.3s ease;
}
.profile-icon:hover { 
  transform: scale(1.1); 
}

/* Modals */
.modal-content { 
  border-radius: 15px; 
  box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
}
.modal-header { 
  background: linear-gradient(45deg, #007bff, #0056b3); 
  color: white; 
  border-radius: 15px 15px 0 0; 
}
.modal-body { 
  padding: 20px; 
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
}

/* Member Lists in Modals */
.border.rounded.p-2 { 
  background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
  border-radius: 8px; 
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); 
}
.member-entry { 
  background: white; 
  padding: 5px 10px; 
  margin-bottom: 5px; 
  border-radius: 5px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  transition: all 0.2s ease; 
}
.member-entry:hover { 
  background: #e9ecef; 
  transform: translateY(-1px); 
}
.add-member-item:hover { 
  background: #e9ecef; 
  cursor: pointer; 
}

/* Life Groups Badge (Blue, Matching Ministry) */
.lifegroups-design {
  text-align: center;
  margin-bottom: 20px;
}
.lifegroups-badge {
  display: inline-block;
  padding: 10px 20px;
  font-size: 1.8rem;
  font-weight: bold;
  color: white;
  background: linear-gradient(45deg, #007bff, #0056b3); /* Blue gradient */
  border-radius: 25px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 15px rgba(0, 123, 255, 0.5); /* Blue glow */
  border: 3px solid #ffc107; /* Yellow border like Ministry */
  font-family: 'Georgia', serif;
  letter-spacing: 1px;
  position: relative;
}
.lifegroups-badge::before {
  content: '';
  position: absolute;
  top: -5px;
  left: -5px;
  right: -5px;
  bottom: -5px;
  background: linear-gradient(45deg, #ffc107, #ffed4e); /* Yellow glow like Ministry */
  border-radius: 30px;
  z-index: -1;
  opacity: 0.7;
}

/* Hamburger & Backdrop */
.hamburger {
  display: none;
  cursor: pointer;
  font-size: 1.5rem;
  color: #343a40;
}
.backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1040;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.backdrop.show { opacity: 1; visibility: visible; }

/* Responsive Adjustments */
@media (max-width: 768px) {
  .hamburger { display: block; position: fixed; top: 15px; left: 15px; z-index: 1100; }
  .sidebar { width: 220px; height: 100vh; position: fixed; top: 0; left: 0; }
  .main-content { margin-left: 0; padding: 20px; }
  .table-container { margin: 20px; padding: 15px; }
  .time-card { top: 15px; left: 15px; }
}
@media (min-width: 769px) {
  .sidebar { transform: translateX(0); }
  .main-content { margin-left: 220px; }
}
</style>
</head>
<body>

<div class="backdrop" id="backdrop"></div>

<!-- Mobile Hamburger -->
<div class="d-md-none p-2">
  <span class="hamburger" id="hamburger"><i class="fa-solid fa-bars"></i></span>
</div>

<!-- Time Card Fixed at Top-Left -->
<div id="datetime" class="time-card"></div>

<div class="sidebar" id="sidebar">
<div class="text-center">
<img src="{{ url_for('static', filename='images/cross-background.jpg') }}" class="sidebar-logo">
</div>
<hr>
   <a href="{{ url_for('admin_dashboard') }}"><i class="fa-solid fa-house"></i> Dashboard</a>

    <a class="collapsed" data-bs-toggle="collapse"
    href="#membersDropdown" role="button" aria-expanded="false" aria-controls="membersDropdown">
        <i class="fa-solid fa-users"></i> Members
        <i class="fa-solid fa-chevron-down float-end"></i>
    </a>
    <div class="collapse" id="membersDropdown">
        <a href="{{ url_for('add_members') }}" class="ps-4 d-block"><i class="fa-solid fa-user-plus me-2"></i> Add Member</a>
        <a href="{{ url_for('view_members') }}" class="ps-4 d-block"><i class="fa-solid fa-table me-2"></i> View Members</a>
    </div>

    <a class="collapsed" data-bs-toggle="collapse"
    href="#ministriesDropdown" role="button" aria-expanded="false" aria-controls="ministriesDropdown">
        <i class="fa-solid fa-church"></i> Ministries
        <i class="fa-solid fa-chevron-down float-end"></i>
    </a>
    <div class="collapse" id="ministriesDropdown">
        <a href="{{ url_for('add_ministry') }}" class="ps-4 d-block"><i class="fa-solid fa-plus me-2"></i> Add Ministry</a>
        <a href="{{ url_for('admin_ministries') }}" class="ps-4 d-block"><i class="fa-solid fa-list me-2"></i> View Ministries</a>
    </div>

    <a class="collapsed" data-bs-toggle="collapse"
    href="#lifegroupsDropdown" role="button" aria-expanded="false" aria-controls="lifegroupsDropdown">
        <i class="fa-solid fa-people-group"></i> Life Groups
        <i class="fa-solid fa-chevron-down float-end"></i>
    </a>
    <div class="collapse" id="lifegroupsDropdown">
       <a href="{{ url_for('add_lifegroup') }}" class="ps-4 d-block"><i class="fa-solid fa-plus me-2"></i> Add LifeGroup</a>
        <a href="{{ url_for('admin_lifegroups') }}" class="ps-4 d-block active"><i class="fa-solid fa-list me-2"></i> View Life Groups</a>
    </div>

    <a class="collapsed" data-bs-toggle="collapse"
    href="#tithesDropdown" role="button" aria-expanded="false" aria-controls="tithesDropdown">
        <i class="fa-solid fa-hand-holding-dollar"></i> Tithes & Expenses
        <i class="fa-solid fa-chevron-down float-end"></i>
    </a>
    <div class="collapse" id="tithesDropdown">
        <a href="{{ url_for('add_tithe') }}" class="ps-4 d-block"><i class="fa-solid fa-plus me-2"></i> Add Tithe</a>
        <a href="{{ url_for('view_tithes') }}" class="ps-4 d-block"><i class="fa-solid fa-table me-2"></i> View Tithes</a>
        <a href="{{ url_for('add_expense') }}" class="ps-4 d-block"><i class="fa-solid fa-circle-plus me-2"></i> Add Expense</a>
        <a href="{{ url_for('view_expenses') }}" class="ps-4 d-block"><i class="fa-solid fa-list me-2"></i> View Expenses</a>
    </div>

    <a class="collapsed" data-bs-toggle="collapse"
     href="#eventsDropdown" role="button" aria-expanded="false" aria-controls="eventsDropdown">
    <i class="fa-solid fa-calendar-days"></i> Events
    <i class="fa-solid fa-chevron-down float-end"></i>
  </a>
  <div class="collapse" id="eventsDropdown">
    <a href="{{ url_for('add_event') }}" class="ps-4 d-block">
      <i class="fa-solid fa-plus me-2"></i> Add Event
    </a>
    <a href="{{ url_for('view_events') }}" class="ps-4 d-block">
      <i class="fa-solid fa-list me-2"></i> View Events
    </a>
  </div>

    <a class="collapsed" data-bs-toggle="collapse"
    href="#usersDropdown" role="button" aria-expanded="false">
        <i class="fa-solid fa-user"></i> Users
        <i class="fa-solid fa-chevron-down float-end"></i>
    </a>
    <div class="collapse" id="usersDropdown">
        <a href="{{ url_for('add_user') }}" class="ps-4 d-block"><i class="fa-solid fa-user-plus me-2"></i> Add User</a>
        <a href="{{ url_for('view_users') }}" class="ps-4 d-block"><i class="fa-solid fa-table me-2"></i> All Users</a>
    </div>
</div>

<div class="main-content">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

<div class="table-container mt-3">
<div class="lifegroups-design mb-3">
  <i class="fa-solid fa-people-group me-2"></i> 
  <span class="lifegroups-badge">Life Groups</span>
</div>
<div class="table-responsive">
<table class="table table-striped align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Life Group Name</th>
      <th>Leader</th>
      <th>Schedule</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for lg in lifegroups %}
    <tr>
      <td>
        <a href="{{ url_for('view_lifegroup_members', lifegroup_id=lg.lifegroup_id) }}" class="text-decoration-none text-primary fw-bold">
          {{ lg.lifegroup_name }}
        </a>
      </td>
      <td>
        {% if lg.leader_id %}
          <a href="{{ url_for('member_profile', member_id=lg.leader_id) }}" class="text-decoration-none text-primary fw-semibold">
            <i class="fa-solid fa-user me-1"></i> {{ lg.leader_name }}
          </a>
        {% else %}
          <span class="text-muted">No Leader</span>
        {% endif %}
      </td>
      <td>{{ lg.schedule }}</td>
      <td>
        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editLGModal{{ lg.lifegroup_id }}">
          <i class="fa-solid fa-pen-to-square"></i> Edit
        </button>
        <a href="{{ url_for('delete_lifegroup', lifegroup_id=lg.lifegroup_id) }}" class="btn btn-sm btn-danger"
          onclick="return confirm('Are you sure you want to delete this Life Group?');">
          <i class="fa-solid fa-trash"></i> Delete
        </a>
      </td>
    </tr>

<!-- Edit Life Group Modal -->
<div class="modal fade" id="editLGModal{{ lg.lifegroup_id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('edit_lifegroup', lifegroup_id=lg.lifegroup_id) }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen"></i> Edit Life Group</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Name -->
          <div class="mb-3">
            <label class="fw-semibold">Life Group Name</label>
            <input type="text" name="lifegroup_name" value="{{ lg.lifegroup_name }}" class="form-control" required>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="4">{{ lg.description }}</textarea>
          </div>

          <!-- Leader Selection -->
          <div class="mb-3 position-relative">
            <label class="fw-semibold">Leader</label>
            <input type="text" id="searchLeader{{ lg.lifegroup_id }}" class=""border rounded p-2 position-absolute bg-white w-100"
                 style="max-height: 150px; overflow-y:auto; z-index:1050; display:none;">
              {% for member in members %}
                <div class="leader-item p-1" data-id="{{ member.member_id }}" data-name="{{ member.first_name }} {{ member.last_name }}" style="cursor:pointer;">
                  {{ member.first_name }} {{ member.last_name }}
                </div>
              {% endfor %}
            </div>
            <input type="hidden" name="leader_id" id="leaderId{{ lg.lifegroup_id }}" value="{{ lg.leader_id }}">
          </div>

          <!-- Current Members -->
          <div class="mb-3">
            <label class="fw-semibold">Current Members</label>
            <div id="currentMembers{{ lg.lifegroup_id }}" class="border rounded p-2" style="max-height:150px; overflow-y:auto;">
              {% if lifegroup_member_ids[lg.lifegroup_id] %}
                {% for member_id in lifegroup_member_ids[lg.lifegroup_id] %}
                  {% set member = members | selectattr('member_id','equalto',member_id) | list | first %}
                  {% if member %}
                    <div class="d-flex justify-content-between align-items-center mb-1 member-entry" data-member-id="{{ member.member_id }}">
                      <span>{{ member.first_name }} {{ member.last_name }}</span>
                      <button type="button" class="btn btn-sm btn-danger remove-member" data-member-id="{{ member.member_id }}">
                        <i class="fa-solid fa-times"></i>
                      </button>
                    </div>
                  {% endif %}
                {% endfor %}
              {% else %}
                <p class="text-muted mb-0">No members assigned.</p>
              {% endif %}
            </div>
            <input type="hidden" name="member_ids" id="memberIds{{ lg.lifegroup_id }}" 
                   value="{% if lifegroup_member_ids[lg.lifegroup_id] %}{{ lifegroup_member_ids[lg.lifegroup_id] | join(',') }}{% endif %}">
          </div>

          <!-- Add Members -->
          <div class="mb-3">
            <label class="fw-semibold">Add Members</label>
            <input type="text" id="searchAddMembers{{ lg.lifegroup_id }}" class="form-control mb-2" placeholder="Search members to add...">
            <div id="addMembersList{{ lg.lifegroup_id }}" class="border rounded p-2" style="max-height:150px; overflow-y:auto; display:none;">
              {% set added_members = lifegroup_member_ids[lg.lifegroup_id] | default([]) %}
              {% for member in members %}
                {% if member.member_id not in added_members and member.member_id != lg.leader_id %}
                  <div class="add-member-item p-1" data-id="{{ member.member_id }}" data-name="{{ member.first_name }} {{ member.last_name }}" style="cursor:pointer;">
                    {{ member.first_name }} {{ member.last_name }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            <small class="text-muted d-block mt-1">Click a member to add. Duplicates are prevented.</small>
          </div>

          <!-- Schedule -->
          <div class="mb-3">
            <label class="fw-semibold">Schedule</label>
            <input type="text" name="schedule" value="{{ lg.schedule }}" class="form-control" required>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endfor %}
  </tbody>
</table>
</div>
</div>

<!-- Profile Dropdown -->
<div class="dropdown position-fixed top-0 end-0 p-2">
  <img src="{{ url_for('static', filename='images/iu.jpg') }}" class="profile-icon dropdown-toggle rounded-circle" data-bs-toggle="dropdown" alt="User">
  <ul class="dropdown-menu dropdown-menu-end">
    <li><a class="dropdown-item" href="/logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
  </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function updateDateTime() {
  const now = new Date();
  const options = { month:'numeric', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' };
  document.getElementById('datetime').innerText = now.toLocaleDateString('en-US', options);
}
setInterval(updateDateTime, 1000);
updateDateTime();

// DYNAMIC MODAL SCRIPT FOR LIFE GROUPS
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.modal').forEach(modal => {
    if (!modal.id.startsWith('editLGModal')) return;
    const lgId = modal.id.replace('editLGModal', '');

    // Leader search
    const leaderSearch = document.getElementById('searchLeader' + lgId);
    const leaderList = document.getElementById('leaderList' + lgId);
    const leaderItems = leaderList.querySelectorAll('.leader-item');
    const leaderIdInput = document.getElementById('leaderId' + lgId);

    leaderSearch.addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      let hasResults = false;
      leaderItems.forEach(item => {
        const name = item.getAttribute('data-name').toLowerCase();
        item.style.display = name.includes(query) ? '' : 'none';
        if (name.includes(query)) hasResults = true;
      });
      leaderList.style.display = hasResults ? 'block' : 'none';
    });

    leaderItems.forEach(item => {
      item.addEventListener('click', function() {
        leaderSearch.value = this.getAttribute('data-name');
        leaderIdInput.value = this.getAttribute('data-id');
        leaderList.style.display = 'none';
      });
    });

    document.addEventListener('click', function(e) {
      if (!leaderSearch.contains(e.target) && !leaderList.contains(e.target)) {
        leaderList.style.display = 'none';
      }
    });

    // Member add/remove
    const searchAddMembers = document.getElementById('searchAddMembers' + lgId);
    const addMembersList = document.getElementById('addMembersList' + lgId);
    const currentMembers = document.getElementById('currentMembers' + lgId);
    const memberIdsInput = document.getElementById('memberIds' + lgId);

    function updateMemberIds() {
      const ids = Array.from(currentMembers.querySelectorAll('.member-entry')).map(el => el.dataset.memberId);
      memberIdsInput.value = ids.join(',');
    }

    searchAddMembers.addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      addMembersList.querySelectorAll('.add-member-item').forEach(item => {
        item.style.display = item.getAttribute('data-name').toLowerCase().includes(query) ? '' : 'none';
      });
      addMembersList.style.display = query ? 'block' : 'none';
    });

    addMembersList.querySelectorAll('.add-member-item').forEach(item => {
      item.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const name = this.getAttribute('data-name');

        if (!currentMembers.querySelector('[data-member-id="' + id + '"]')) {
          const div = document.createElement('div');
          div.className = 'd-flex justify-content-between align-items-center mb-1 member-entry';
          div.dataset.memberId = id;
          div.innerHTML = `<span>${name}</span>
            <button type="button" class="btn btn-sm btn-danger remove-member" data-member-id="${id}">
              <i class="fa-solid fa-times"></i>
            </button>`;
          currentMembers.appendChild(div);
          updateMemberIds();

          div.querySelector('.remove-member').addEventListener('click', function() {
            div.remove();
            updateMemberIds();
          });
        }
        this.style.display = 'none';
      });
    });

    currentMembers.querySelectorAll('.remove-member').forEach(btn => {
      btn.addEventListener('click', function() {
        btn.parentElement.remove();
        updateMemberIds();
      });
    });

    updateMemberIds();
  });

  // Elements
  const sidebar = document.getElementById("sidebar");
  const backdrop = document.getElementById("backdrop");
  const hamburger = document.getElementById("hamburger");

  // Toggle sidebar
  function toggleSidebar() {
    sidebar.classList.toggle("show");
    backdrop.classList.toggle("show");
  }

  // Event listeners
  hamburger.addEventListener("click", toggleSidebar);
  backdrop.addEventListener("click", toggleSidebar);

  // Close sidebar on link click (mobile)
  sidebar.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", () => {
      if(window.innerWidth <= 768) toggleSidebar();
    });
  });

  // Make sidebar clickable to close on mobile (clicking on sidebar background, not links)
  sidebar.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && !e.target.closest('a')) {
      toggleSidebar();
    }
  });

  // Keep dropdown open if it has an active link
  document.querySelectorAll('.collapse').forEach(collapse => {
    if (collapse.querySelector('.active')) {
      collapse.classList.add('show');
    }
  });
});

const sidebar = document.getElementById("sidebar");
const hamburger = document.getElementById("hamburger");
const backdrop = document.getElementById("backdrop");

hamburger.addEventListener("click", () => {
    sidebar.classList.toggle("show");
    backdrop.classList.toggle("show");
});

backdrop.addEventListener("click", () => {
    sidebar.classList.remove("show");
    backdrop.classList.remove("show");
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



